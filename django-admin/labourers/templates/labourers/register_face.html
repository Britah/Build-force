{% extends 'labourers/base.html' %}

{% block content %}
<div class="card">
    <h2><i class="fas fa-user-circle"></i> Register Face for {{ labourer.full_name }}</h2>
    
    <div style="text-align: center; margin: 30px 0;">
        <video id="video" width="640" height="480" autoplay style="border: 2px solid #007bff; border-radius: 5px;"></video>
        <canvas id="canvas" style="display: none;"></canvas>
    </div>
    
    <div id="result" style="display: none; margin: 20px 0; padding: 15px; border-radius: 5px;"></div>
    
    <div style="text-align: center;">
        <button id="captureBtn" class="btn btn-primary">
            <i class="fas fa-camera"></i> Capture & Register Face
        </button>
        <button id="retryBtn" class="btn btn-secondary" style="display: none;">
            <i class="fas fa-redo"></i> Retry
        </button>
        <a href="{% url 'labourers' %}" class="btn btn-danger">
            <i class="fas fa-times"></i> Cancel
        </a>
    </div>
    
    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 5px;">
        <h4><i class="fas fa-info-circle"></i> Instructions:</h4>
        <ul>
            <li>Position face in center of camera</li>
            <li>Ensure good lighting</li>
            <li>Look directly at camera</li>
            <li>Keep neutral expression</li>
            <li>Remove glasses if possible</li>
        </ul>
    </div>
</div>

<script>
let stream = null;

// Start camera
function startCamera() {
    const video = document.getElementById('video');
    
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
    
    navigator.mediaDevices.getUserMedia({ 
        video: { width: 640, height: 480 },
        audio: false 
    })
    .then(function(mediaStream) {
        stream = mediaStream;
        video.srcObject = mediaStream;
    })
    .catch(function(err) {
        alert('Camera error: ' + err.message);
    });
}

// Capture image
document.getElementById('captureBtn').addEventListener('click', function() {
    const video = document.getElementById('video');
    const canvas = document.createElement('canvas');
    canvas.width = 640;
    canvas.height = 480;
    const ctx = canvas.getContext('2d');
    
    // Draw video frame
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Convert to base64
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    
    // Show processing
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = '<div style="text-align: center; color: #666;"><i class="fas fa-spinner fa-spin"></i> Processing face registration...</div>';
    resultDiv.style.display = 'block';
    resultDiv.style.background = '#f8f9fa';
    
    // Send to server
    const formData = new FormData();
    formData.append('image_data', imageData);
    
    fetch(`/labourers/${ {{ labourer.id }} }/register-face-simple/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `
                <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; text-align: center;">
                    <i class="fas fa-check-circle"></i> <strong>Success!</strong>
                    <p>${data.message}</p>
                    <p>Face registered for ${ {{ labourer.full_name|escapejs }} }</p>
                </div>
            `;
            
            // Redirect after 2 seconds
            setTimeout(() => {
                window.location.href = "{% url 'labourers' %}";
            }, 2000);
            
        } else {
            resultDiv.innerHTML = `
                <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px;">
                    <i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong>
                    <p>${data.error}</p>
                </div>
            `;
            document.getElementById('retryBtn').style.display = 'inline-block';
        }
    })
    .catch(error => {
        resultDiv.innerHTML = `
            <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px;">
                <i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong>
                <p>${error.message}</p>
            </div>
        `;
        document.getElementById('retryBtn').style.display = 'inline-block';
    });
});

// Retry button
document.getElementById('retryBtn').addEventListener('click', function() {
    document.getElementById('result').style.display = 'none';
    this.style.display = 'none';
});

// Start camera on page load
window.addEventListener('DOMContentLoaded', startCamera);
</script>
{% endblock %}