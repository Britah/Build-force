<!DOCTYPE html>
<html>
<head>
    <title>Geofence Test</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        #status { padding: 15px; border-radius: 8px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        #map { width: 100%; height: 400px; border: 2px solid #ccc; }
    </style>
    <!-- Leaflet CSS for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <h2>üìç Construction Site Geofence Test</h2>
    
    <div id="status" class="info">Click "Check Location" to start...</div>
    
    <button onclick="checkSiteLocation()">Check Location</button>
    <button onclick="startContinuousTracking()">Start Continuous Tracking</button>
    <button onclick="stopTracking()">Stop Tracking</button>
    
    <div id="map"></div>
    
    <div style="margin-top: 20px;">
        <h3>Site Boundary (Burhani Engineers)</h3>
        <p>üìç Center: -1.2886166649661568, 36.791409802462454</p>
        <p>üìè Radius: 100 meters</p>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([-1.2886166649661568, 36.791409802462454], 18);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);
        
        // Site boundary (Burhani Engineers)
        const SITE_CENTER = [-1.2886166649661568, 36.791409802462454];
        const SITE_RADIUS = 100; // meters
        
        // Add site boundary to map
        const siteCircle = L.circle(SITE_CENTER, {
            color: 'green',
            fillColor: '#30ff30',
            fillOpacity: 0.2,
            radius: SITE_RADIUS
        }).addTo(map);
        
        L.marker(SITE_CENTER).addTo(map)
            .bindPopup('Burhani Engineers Site')
            .openPopup();
        
        let userMarker = null;
        let watchId = null;

        // 1. Calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        // 2. Check if within site boundary
        function isWithinSite(latitude, longitude) {
            const distance = calculateDistance(
                latitude, longitude,
                SITE_CENTER[0], SITE_CENTER[1]
            );
            
            return {
                within: distance <= SITE_RADIUS,
                distance: Math.round(distance),
                radius: SITE_RADIUS
            };
        }

        // 3. Get current location
        function checkSiteLocation() {
            const status = document.getElementById('status');
            status.className = 'info';
            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting your location...';
            
            if (!navigator.geolocation) {
                status.className = 'error';
                status.textContent = 'Geolocation not supported by your browser';
                return;
            }
            
            const options = {
                enableHighAccuracy: true,   // Use GPS if available
                timeout: 10000,            // 10 seconds timeout
                maximumAge: 0              // Don't use cached location
            };
            
            navigator.geolocation.getCurrentPosition(
                // Success callback
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    // Update map
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }
                    userMarker = L.marker([lat, lng]).addTo(map)
                        .bindPopup(`Your location<br>Accuracy: ${Math.round(accuracy)}m`)
                        .openPopup();
                    
                    // Pan to user location
                    map.setView([lat, lng], 18);
                    
                    // Add accuracy circle
                    L.circle([lat, lng], {
                        color: 'blue',
                        fillColor: '#30a0ff',
                        fillOpacity: 0.2,
                        radius: accuracy
                    }).addTo(map);
                    
                    // Check if within site
                    const result = isWithinSite(lat, lng);
                    
                    if (result.within) {
                        status.className = 'success';
                        status.innerHTML = `
                            ‚úÖ <strong>ON SITE!</strong><br>
                            Distance from center: ${result.distance}m (within ${result.radius}m)<br>
                            Accuracy: ${Math.round(accuracy)}m<br>
                            üìç ${lat.toFixed(6)}, ${lng.toFixed(6)}
                        `;
                    } else {
                        status.className = 'error';
                        status.innerHTML = `
                            ‚ùå <strong>OFF SITE!</strong><br>
                            You are ${result.distance}m away from site<br>
                            Must be within ${result.radius}m radius<br>
                            Accuracy: ${Math.round(accuracy)}m
                        `;
                    }
                },
                
                // Error callback
                function(error) {
                    status.className = 'error';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            status.textContent = 'Location permission denied. Please enable location services.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            status.textContent = 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            status.textContent = 'Location request timed out.';
                            break;
                        default:
                            status.textContent = 'Unknown error getting location.';
                    }
                },
                
                options
            );
        }

        // 4. Continuous tracking (for real-time monitoring)
        function startContinuousTracking() {
            if (watchId) return;
            
            const status = document.getElementById('status');
            status.className = 'info';
            status.textContent = 'Starting continuous tracking...';
            
            watchId = navigator.geolocation.watchPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const result = isWithinSite(lat, lng);
                    
                    // Update user marker
                    if (userMarker) {
                        userMarker.setLatLng([lat, lng]);
                    } else {
                        userMarker = L.marker([lat, lng]).addTo(map);
                    }
                    
                    // Update status
                    const time = new Date().toLocaleTimeString();
                    if (result.within) {
                        status.className = 'success';
                        status.innerHTML = `‚úÖ ON SITE | ${time} | ${result.distance}m from center`;
                    } else {
                        status.className = 'error';
                        status.innerHTML = `‚ùå OFF SITE | ${time} | ${result.distance}m away`;
                    }
                },
                
                function(error) {
                    console.error('Tracking error:', error);
                },
                
                {
                    enableHighAccuracy: true,
                    maximumAge: 3000,  // Update every 3 seconds
                    timeout: 5000
                }
            );
        }
        
        function stopTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                document.getElementById('status').textContent = 'Tracking stopped';
            }
        }

        // 5. Simulate attendance check-in with location
        function simulateAttendanceCheckIn() {
            checkSiteLocation(); // Get location first
            
            setTimeout(() => {
                const status = document.getElementById('status');
                const statusText = status.textContent;
                
                if (statusText.includes('ON SITE')) {
                    // Open camera for photo verification
                    alert('Location verified! Opening camera for attendance...');
                    openCameraForAttendance();
                } else {
                    alert('Cannot check in: You must be on site.');
                }
            }, 2000);
        }

        // 6. Open camera (for attendance photo)
        function openCameraForAttendance() {
            // Check if browser supports camera
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('Camera not supported in this browser');
                return;
            }
            
            // Request camera access
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(stream) {
                    alert('Camera ready! Take photo for attendance.');
                    // Here you would show camera preview and capture photo
                })
                .catch(function(error) {
                    alert('Camera error: ' + error.message);
                });
        }

        // Auto-check when page loads (optional)
        // window.addEventListener('load', checkSiteLocation);
    </script>
</body>
</html>